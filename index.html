<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAEIV Vélo - Navigation en Temps Réel</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        .map-container {
            height: 50vh;
            width: 100%;
        }
        .info {
            padding: 10px;
            font-size: 18px;
        }
        .line-buttons {
            margin: 20px 0;
        }
        .blinking {
            background-color: red;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }
        .stations-table {
            width: 100%;
            margin-top: 10px;
        }
        .stations-table th, .stations-table td {
            padding: 5px;
            text-align: left;
        }
        .night-mode {
            background-color: #001f3f;
            color: white;
        }
    </style>
</head>
<body class="w3-light-grey w3-large">

    <div class="w3-container w3-center">
        <h2>SAEIV Vélo - Navigation en Temps Réel</h2>
        <!-- Boutons de sélection des lignes -->
        <div id="line-selection" class="line-buttons w3-padding"></div>
        <button class="w3-button w3-round w3-blue" onclick="toggleNightMode()">Mode Nuit</button>
        <div id="map" class="map-container w3-round w3-white"></div>
        <div id="route-info" class="w3-padding w3-white w3-round w3-margin-top info"></div>
        <table id="stations-table" class="w3-table w3-bordered w3-white w3-round stations-table"></table>
        <h4>Historique des stations passées</h4>
        <ul id="history" class="w3-ul w3-card-4"></ul>
    </div>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        // Arrêts prédéfinis pour chaque ligne
        const stops = [
            { id: 1, name: 'Station A', lat: 48.8566, lng: 2.3522 }, 
            { id: 2, name: 'Station B', lat: 48.8606, lng: 2.3376 }, 
            { id: 3, name: 'Station C', lat: 48.8656, lng: 2.3212 }, 
            { id: 4, name: 'Station D', lat: 48.8706, lng: 2.3126 }, 
            { id: 5, name: 'Station E', lat: 48.8756, lng: 2.3012 }  
        ];

        const routes = [
            { name: 'Ligne 1', stops: [1, 2, 3] },
            { name: 'Ligne 2', stops: [3, 4, 5] }
        ];

        let currentPosition = null;
        let currentStopIndex = 0;
        let selectedRoute = null;
        let mapMarkers = [];
        let routingControl = null;
        let userMarker = null;
        let history = [];

        const map = L.map('map').setView([48.8566, 2.3522], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        function displayLineButtons() {
            const lineSelectionDiv = document.getElementById('line-selection');
            routes.forEach((route, index) => {
                const button = document.createElement('button');
                button.className = 'w3-button w3-round w3-white w3-margin-right';
                button.innerText = route.name;
                button.onclick = () => selectRoute(index);
                lineSelectionDiv.appendChild(button);
            });
        }

        function selectRoute(routeIndex) {
            selectedRoute = routes[routeIndex];
            currentStopIndex = 0;
            updateMapForSelectedRoute();
        }

        function updateMapForSelectedRoute() {
            if (routingControl) map.removeControl(routingControl);
            const waypoints = selectedRoute.stops.map(id => {
                const stop = stops.find(s => s.id === id);
                return L.latLng(stop.lat, stop.lng);
            });
            routingControl = L.Routing.control({
                waypoints,
                routeWhileDragging: false,
                createMarker: () => null,
                lineOptions: { styles: [{ color: 'blue', opacity: 0.7, weight: 5 }] }
            }).addTo(map);
            displayStationsTable();
        }

        function displayStationsTable() {
            const table = document.getElementById('stations-table');
            table.innerHTML = '<tr><th>Station</th><th>Distance</th></tr>';
            const { latitude, longitude } = currentPosition || {};
            selectedRoute.stops.slice(currentStopIndex).forEach(stopId => {
                const stop = stops.find(s => s.id === stopId);
                const distance = currentPosition ? getDistance(latitude, longitude, stop.lat, stop.lng) : '-';
                table.innerHTML += `<tr><td>${stop.name}</td><td>${Math.round(distance)}m</td></tr>`;
            });
        }

        function speak(message) {
            const speech = new SpeechSynthesisUtterance(message);
            speech.lang = 'fr-FR';
            window.speechSynthesis.speak(speech);
        }

        navigator.geolocation.watchPosition(position => {
            const { latitude, longitude } = position.coords;
            currentPosition = { latitude, longitude };

            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([latitude, longitude], {
                radius: 8, color: 'red', className: 'blinking'
            }).addTo(map);

            displayStationsTable();
        }, console.error, { enableHighAccuracy: true });

        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
        }

        displayLineButtons();
    </script>
</body>
</html>
